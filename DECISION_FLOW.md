# Trade Decision Flow - Visual Guide

## ğŸ¯ High-Level Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          TRADE DECISION PROCESS                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Market Data (Price, Volume, Options Chain)
                    â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                         â”‚                         â”‚
                    â–¼                         â–¼                         â–¼
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“     â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“     â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
        â”ƒ Hedge Engine v0 â”ƒ     â”ƒLiquidity Eng v0 â”ƒ     â”ƒSentiment Eng v0 â”ƒ
        â”ƒ                 â”ƒ     â”ƒ                 â”ƒ     â”ƒ                 â”ƒ
        â”ƒ â€¢ Gamma/Vanna   â”ƒ     â”ƒ â€¢ Amihud        â”ƒ     â”ƒ â€¢ Momentum Z    â”ƒ
        â”ƒ â€¢ Gamma Walls   â”ƒ     â”ƒ â€¢ Kyle Lambda   â”ƒ     â”ƒ â€¢ Volatility Z  â”ƒ
        â”ƒ â€¢ Hedge Force   â”ƒ     â”ƒ â€¢ Volume Zones  â”ƒ     â”ƒ â€¢ Regime Class  â”ƒ
        â”—â”â”â”â”â”â”â”â”â”¯â”â”â”â”â”â”â”â”›     â”—â”â”â”â”â”â”â”â”â”¯â”â”â”â”â”â”â”â”›     â”—â”â”â”â”â”â”â”â”â”¯â”â”â”â”â”â”â”â”›
                 â”‚                      â”‚                      â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚   L3 Canonical        â”‚
                            â”‚   Feature Store       â”‚
                            â”‚   (Parquet)           â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚                      â”‚                      â”‚
                 â–¼                      â–¼                      â–¼
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
        â”ƒ Agent 1      â”ƒ      â”ƒ Agent 2      â”ƒ      â”ƒ Agent 3      â”ƒ
        â”ƒ HEDGE        â”ƒ      â”ƒ LIQUIDITY    â”ƒ      â”ƒ SENTIMENT    â”ƒ
        â”ƒ              â”ƒ      â”ƒ              â”ƒ      â”ƒ              â”ƒ
        â”ƒ dir: +1      â”ƒ      â”ƒ dir: -1      â”ƒ      â”ƒ dir: +1      â”ƒ
        â”ƒ conf: 0.78   â”ƒ      â”ƒ conf: 0.62   â”ƒ      â”ƒ conf: 0.68   â”ƒ
        â”ƒ thesis:      â”ƒ      â”ƒ thesis:      â”ƒ      â”ƒ thesis:      â”ƒ
        â”ƒ "breakout_up"â”ƒ      â”ƒ "resist_dom" â”ƒ      â”ƒ "risk_on"    â”ƒ
        â”—â”â”â”â”â”â”â”¯â”â”â”â”â”â”â”â”›      â”—â”â”â”â”â”â”â”¯â”â”â”â”â”â”â”â”›      â”—â”â”â”â”â”â”â”¯â”â”â”â”â”â”â”â”›
               â”‚                     â”‚                     â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚   COMPOSER v1     â”‚
                           â”‚   (2-of-3 Voting) â”‚
                           â”‚                   â”‚
                           â”‚ â€¢ Alignment check â”‚
                           â”‚ â€¢ Score weighting â”‚
                           â”‚ â€¢ Liquidity size  â”‚
                           â”‚ â€¢ Time stop calc  â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                                 â”‚
                    â–¼                                 â–¼
        â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
        â”ƒ  TAKE TRADE      â”ƒ            â”ƒ  PASS (NO TRADE) â”ƒ
        â”ƒ                  â”ƒ            â”ƒ                  â”ƒ
        â”ƒ direction: long  â”ƒ            â”ƒ reason:          â”ƒ
        â”ƒ confidence: 0.70 â”ƒ            â”ƒ "no_alignment"   â”ƒ
        â”ƒ size_hint: 0.65  â”ƒ            â”ƒ or               â”ƒ
        â”ƒ time_stop: 8 bar â”ƒ            â”ƒ "mixed_signals"  â”ƒ
        â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›            â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
```

---

## ğŸ“Š Agent Decision Trees

### Agent 1: Hedge (Positioning)

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Hedge Features  â”‚
                    â”‚ â€¢ hedge_force   â”‚
                    â”‚ â€¢ regime        â”‚
                    â”‚ â€¢ wall_dist     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                         â”‚
                â–¼                         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ regime="pin"  â”‚         â”‚ regime â‰  pin  â”‚
        â”‚ (|force|<0.2) â”‚         â”‚               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                         â”‚
                â–¼                         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ dir_bias = 0  â”‚         â”‚ force > 0.001 â†’ dir_bias = +1 â”‚
        â”‚ conf Ã— 0.6    â”‚         â”‚ force < -0.001â†’ dir_bias = -1 â”‚
        â”‚ (penalize)    â”‚         â”‚ else â†’ dir_bias = 0           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â–¼
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚ wall_dist < 2?â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚                       â”‚
                              â–¼                       â–¼
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â”‚ YES           â”‚       â”‚ NO            â”‚
                      â”‚ conf Ã— 1.2    â”‚       â”‚ conf (normal) â”‚
                      â”‚ (boost)       â”‚       â”‚               â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

OUTPUT: AgentView(agent="hedge", dir_bias=Â±1/0, confidence=0-1, thesis)
```

---

### Agent 2: Liquidity (Terrain)

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚Liquidity Featureâ”‚
                    â”‚ â€¢ support zones â”‚
                    â”‚ â€¢ resist zones  â”‚
                    â”‚ â€¢ next_magnet   â”‚
                    â”‚ â€¢ amihud        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                         â”‚
                â–¼                         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ next_magnet   â”‚         â”‚ No magnet,    â”‚
        â”‚ exists?       â”‚         â”‚ use zone prox â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                         â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
        â”‚                â”‚                â”‚
        â–¼                â–¼                â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚magnet > â”‚      â”‚magnet < â”‚    â”‚nearest sup  â”‚
  â”‚ spot    â”‚      â”‚ spot    â”‚    â”‚vs resist    â”‚
  â”‚         â”‚      â”‚         â”‚    â”‚comparison   â”‚
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                â”‚                â”‚
       â–¼                â–¼                â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚dir:+1   â”‚      â”‚dir:-1   â”‚    â”‚dir: Â±1/0    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          
                    Confidence Scaling
                           â”‚
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ liq_quality = â”‚
                    â”‚ -log10(amihud)â”‚
                    â”‚ / 15          â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚conf = base_confâ”‚
                    â”‚ Ã— liq_quality â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

OUTPUT: AgentView(agent="liquidity", dir_bias=Â±1/0, confidence=0-1, levels={zones})
```

---

### Agent 3: Sentiment (Mood)

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚Sentiment Featureâ”‚
                    â”‚ â€¢ regime        â”‚
                    â”‚ â€¢ momo_z        â”‚
                    â”‚ â€¢ vol_z         â”‚
                    â”‚ â€¢ flip_prob     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                         â”‚
                â–¼                         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚regime="risk_onâ”‚         â”‚ Other regime  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                         â”‚
                â–¼                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚                â”‚
        â”‚ dir_bias = +1 â”‚         â–¼                â–¼
        â”‚ thesis:       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ "risk_on"     â”‚  â”‚risk_off  â”‚    â”‚ neutral  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚dir: -1   â”‚    â”‚use momo_zâ”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                                                â”‚
                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
                                        â”‚               â”‚
                                        â–¼               â–¼
                                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                  â”‚momo_z   â”‚     â”‚momo_z   â”‚
                                  â”‚> 0.3    â”‚     â”‚< -0.3   â”‚
                                  â”‚dir: +1  â”‚     â”‚dir: -1  â”‚
                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    Confidence Adjustments
                           â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚               â”‚               â”‚
           â–¼               â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚momo boostâ”‚   â”‚vol penaltyâ”‚  â”‚flip penaltyâ”‚
    â”‚min(0.2,  â”‚   â”‚0.1Ã—|vol_z|â”‚  â”‚0.7Ã—flip_p â”‚
    â”‚|momo|/5) â”‚   â”‚           â”‚  â”‚          â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
          â”‚              â”‚             â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ conf_final = â”‚
                  â”‚ conf + boost â”‚
                  â”‚ - penalties  â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

OUTPUT: AgentView(agent="sentiment", dir_bias=Â±1/0, confidence=0-1, thesis)
```

---

## ğŸ² Composer Logic (2-of-3 Voting)

```
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚   3 Agent Views      â”‚
                     â”‚   (v1, v2, v3)       â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Reliability Weights  â”‚
                    â”‚  w = conf Ã— reliabilityâ”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                               â”‚
                â–¼                               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ up_score =    â”‚             â”‚ down_score =  â”‚
        â”‚ Î£ w[v] for    â”‚             â”‚ Î£ w[v] for    â”‚
        â”‚ v.dir > 0     â”‚             â”‚ v.dir < 0     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                               â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Alignment Check       â”‚
                    â”‚ Need 2+ agents with:  â”‚
                    â”‚ â€¢ Same direction      â”‚
                    â”‚ â€¢ conf >= 0.6         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚               â”‚               â”‚
                â–¼               â–¼               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ 2+ alignedâ”‚   â”‚ 2+ alignedâ”‚   â”‚ No align  â”‚
        â”‚ bullish   â”‚   â”‚ bearish   â”‚   â”‚           â”‚
        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
              â”‚               â”‚               â”‚
              â–¼               â–¼               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚up_score > â”‚   â”‚down_score>â”‚   â”‚ PASS      â”‚
        â”‚down*1.2?  â”‚   â”‚up*1.2?    â”‚   â”‚ NO TRADE  â”‚
        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚               â”‚
        â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
        â”‚    YES    â”‚   â”‚    YES    â”‚
        â–¼           â–¼   â–¼           â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚TAKE LONGâ”‚ â”‚  PASS   â”‚ â”‚TAKE SHORTâ”‚ â”‚  PASS   â”‚
  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Calculate Sizing      â”‚
        â”‚   based on Amihud       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Calculate Time Stop   â”‚
        â”‚   based on flip_prob    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  TRADE IDEA    â”‚
            â”‚  Output        â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”¢ Position Sizing Formula

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Position Sizing Logic                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Amihud Illiquidity Measure
              â”‚
              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ log_amihud =    â”‚
    â”‚ log10(amihud)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                             â”‚
    â–¼                                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚log_amihud   â”‚                           â”‚log_amihud   â”‚
â”‚<= -12       â”‚                           â”‚>= -8        â”‚
â”‚             â”‚                           â”‚             â”‚
â”‚Very Liquid  â”‚                           â”‚ Illiquid    â”‚
â”‚SPY, AAPL    â”‚                           â”‚ Small cap   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                         â”‚
       â–¼                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚size_mult=1.0â”‚                           â”‚size_mult=0.25â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                         â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Between -12 and -8:   â”‚
              â”‚ Linear interpolation  â”‚
              â”‚ size_mult = 1.0 -     â”‚
              â”‚ 0.75Ã—(log+12)/4       â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Adjust by confidence: â”‚
              â”‚ size_mult Ã—           â”‚
              â”‚ (0.5 + confidence)    â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
                  Final Position Size

Example:
  amihud = 1.2e-10 â†’ log = -9.92
  size_mult = 1.0 - 0.75Ã—(-9.92+12)/4 = 0.61
  If confidence = 0.70:
    final_size = 0.61 Ã— (0.5 + 0.70) = 0.73
```

---

## â±ï¸ Time Stop Calculation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Time Stop Logic                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    Sentiment flip_prob (from agent3)
              â”‚
              â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ flip_prob =     â”‚
    â”‚ probability of  â”‚
    â”‚ regime change   â”‚
    â”‚ in next 10 bars â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                             â”‚
    â–¼                                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚flip_prob    â”‚                           â”‚flip_prob    â”‚
â”‚< 0.3        â”‚                           â”‚> 0.7        â”‚
â”‚             â”‚                           â”‚             â”‚
â”‚ Low risk    â”‚                           â”‚ High risk   â”‚
â”‚ Strong trendâ”‚                           â”‚ Choppy      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                         â”‚
       â–¼                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚eta_bars=10-12â”‚                          â”‚eta_bars=4-5 â”‚
â”‚             â”‚                           â”‚             â”‚
â”‚Hold longer  â”‚                           â”‚Exit quickly â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Formula:
  eta_bars = max(4, min(12, 10 Ã— (1 - flip_prob)))

Examples:
  flip_prob = 0.2 â†’ eta = 10Ã—0.8 = 8 bars
  flip_prob = 0.5 â†’ eta = 10Ã—0.5 = 5 bars
  flip_prob = 0.8 â†’ eta = 10Ã—0.2 = 2 â†’ clipped to 4 bars
```

---

## ğŸ¯ Trade Execution Timeline

```
Bar t=0     Bar t=1     Bar t=2  ...  Bar t=N
  â”‚           â”‚           â”‚             â”‚
  â–¼           â–¼           â–¼             â–¼
â”Œâ”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”
â”‚ READâ”‚     â”‚ENTRYâ”‚     â”‚ MTM â”‚       â”‚EXIT â”‚
â”‚ L3  â”‚â”€â”€â”€â”€â–¶â”‚ Fillâ”‚â”€â”€â”€â”€â–¶â”‚ P&L â”‚â”€â”€Â·Â·Â·â”€â–¶â”‚ Fillâ”‚
â”‚FEAT â”‚     â”‚ +Slipâ”‚     â”‚     â”‚       â”‚+Slipâ”‚
â””â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”˜

Details:
â€¢ t=0: Read features, build agent views, compose idea
â€¢ t=1: Execute at NEXT bar price + slippage
â€¢ t=2..N-1: Monitor position, track MTM P&L
â€¢ t=N: Exit on time stop OR direction flip OR EOD

Slippage Application:
â€¢ Long entry:  buy_price = next_bar_px + slippage
â€¢ Long exit:   sell_price = next_bar_px - slippage
â€¢ Short entry: sell_price = next_bar_px - slippage
â€¢ Short exit:  buy_price = next_bar_px + slippage
```

---

## ğŸ“Š Example Scenario Walkthrough

### Scenario: Bullish Breakout Setup

**Input Data:**
```
Symbol: SPY
Price: $451.62
Time: 2025-11-03 10:30:00
Volume: 12,500 shares
```

**Engine Outputs:**

1. **Hedge Engine:**
   - Gamma Net: +$500M (bullish dealer pressure)
   - Hedge Force: +0.34
   - Regime: "neutral"
   - Gamma Wall: $452 strike (1.5 points away)

2. **Liquidity Engine:**
   - Amihud: 1.2e-10 (liquid)
   - Support: [$450.20-$450.80]
   - Resistance: [$452.10-$452.50], [$453.00-$453.30]
   - Next Magnet: $452.30

3. **Sentiment Engine:**
   - Momentum Z: +1.2 (strong bullish momentum)
   - Vol Z: -0.5 (suppressed volatility)
   - Regime: "risk_on"
   - Flip Prob: 0.25 (low)

**Agent Views:**

1. **Agent 1 (Hedge):**
   ```
   dir_bias: +1.0 (bullish breakout expected)
   confidence: 0.78 (high, near gamma wall)
   thesis: "breakout_up"
   ```

2. **Agent 2 (Liquidity):**
   ```
   dir_bias: -1.0 (near resistance, expect rejection)
   confidence: 0.62 (moderate, zones present)
   thesis: "resistance_dominant"
   ```

3. **Agent 3 (Sentiment):**
   ```
   dir_bias: +1.0 (risk-on regime, strong momentum)
   confidence: 0.68 (good, low flip risk)
   thesis: "risk_on_follow"
   ```

**Composer Decision:**

```
Alignment Check:
â€¢ Bullish agents: hedge (0.78), sentiment (0.68) â†’ 2 agents âœ“
â€¢ Both conf >= 0.6 âœ“
â€¢ up_score = 0.78 + 0.68 = 1.46
â€¢ down_score = 0.62
â€¢ 1.46 > 0.62 Ã— 1.2 (0.74) âœ“

Sizing:
â€¢ log(1.2e-10) = -9.92
â€¢ size_mult = 0.61
â€¢ Ã— (0.5 + 0.70) = 0.73

Time Stop:
â€¢ flip_prob = 0.25
â€¢ eta_bars = 10 Ã— (1 - 0.25) = 7.5 â†’ 8 bars

DECISION: TAKE LONG
â€¢ Direction: long
â€¢ Confidence: 0.70
â€¢ Size: 0.73 Ã— base_size
â€¢ Hold: 8 bars (~8 minutes)
```

**Execution:**
```
t=10:30: Decision made
t=10:31: Enter long at $451.68 (price $451.62 + 6Â¢ slippage)
t=10:39: Time stop expires OR price action triggers exit
```

---

*For detailed architecture, see `ARCHITECTURE_REPORT.md`*  
*For quick commands, see `QUICK_START.md`*
